<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Najah Tutors</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            min-height: 100vh;
            background: #f5f7fb;
            font-family: 'Poppins', sans-serif;
        }
        .gradient-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        }
    </style>
</head>
<body class="bg-gray-100">
    <header class="gradient-card p-6 shadow-lg">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold">Welcome back, <span id="studentName">Student</span> ðŸ‘‹</h1>
                <p class="text-indigo-100 mt-2">Here's a quick overview of your learning journey.</p>
            </div>
            <button id="logoutBtn" class="mt-4 md:mt-0 bg-white text-purple-700 px-6 py-2 rounded-full font-semibold hover:bg-purple-50 transition">
                Logout
            </button>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-6 space-y-8">
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="card p-6">
                <h3 class="text-gray-500 font-semibold">Upcoming Class</h3>
                <p class="text-3xl font-bold mt-4" id="nextClass">Loading...</p>
                <p class="text-gray-500 mt-2">Stay ready and join on time!</p>
            </div>
            <div class="card p-6">
                <h3 class="text-gray-500 font-semibold">Subjects Enrolled</h3>
                <p class="text-3xl font-bold mt-4" id="subjectsCount">--</p>
                <p class="text-gray-500 mt-2" id="subjectsList">Fetching your subjects...</p>
            </div>
            <div class="card p-6">
                <h3 class="text-gray-500 font-semibold">Progress</h3>
                <p class="text-3xl font-bold mt-4" id="progressStat">--%</p>
                <p class="text-gray-500 mt-2">Keep pushing towards excellence!</p>
            </div>
        </section>

        <section class="card p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-gray-800">My Subjects</h2>
                <a href="live_classes.html#courses" class="text-purple-600 font-semibold hover:underline">Browse more</a>
            </div>
            <div id="subjectsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <p class="text-gray-500">Loading your subjects...</p>
            </div>
        </section>

        <section class="card p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Latest Invoice</h2>
                <span id="invoiceDate" class="text-sm text-gray-500"></span>
            </div>
            <div id="invoiceContainer">
                <p class="text-gray-500">Loading your invoice...</p>
            </div>
        </section>
    </main>

    <script>
        const API_BASE_URL = window.location.protocol.startsWith('http')
            ? `${window.location.protocol}//${window.location.hostname}${window.location.port ? `:${window.location.port}` : ''}/api`
            : 'http://localhost:5000/api';

        const token = localStorage.getItem('studentToken') || sessionStorage.getItem('studentToken');
        if (!token) {
            window.location.href = 'login.html';
        }

        const studentNameEl = document.getElementById('studentName');
        const nextClassEl = document.getElementById('nextClass');
        const subjectsCountEl = document.getElementById('subjectsCount');
        const subjectsListEl = document.getElementById('subjectsList');
        const subjectsContainer = document.getElementById('subjectsContainer');
        const progressStatEl = document.getElementById('progressStat');
        const invoiceContainer = document.getElementById('invoiceContainer');
        const invoiceDateEl = document.getElementById('invoiceDate');

        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('studentToken');
            localStorage.removeItem('studentName');
            sessionStorage.removeItem('studentToken');
            window.location.href = 'login.html';
        });

        const populateSubjects = (subjects = []) => {
            if (!subjects.length) {
                subjectsContainer.innerHTML = '<p class="text-gray-500">No subjects found yet. Please contact support if this is unexpected.</p>';
                subjectsCountEl.textContent = '0';
                subjectsListEl.textContent = 'No subjects available';
                return;
            }

            subjectsCountEl.textContent = subjects.length;
            subjectsListEl.textContent = subjects.map(s => s.subject || s).join(', ');
            subjectsContainer.innerHTML = subjects.map(subject => `
                <div class="p-5 border rounded-2xl hover:border-purple-500 transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800">${subject.subject || subject}</h3>
                            <p class="text-gray-500 text-sm mt-1">Class ${subject.class || '--'} â€¢ ${subject.board || '--'}</p>
                        </div>
                        <span class="text-purple-600 text-xl">
                            <i class="fas fa-book"></i>
                        </span>
                    </div>
                </div>
            `).join('');
        };

        const loadDashboard = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!response.ok) {
                    throw new Error('Session expired. Please log in again.');
                }

                const { data: user } = await response.json();
                studentNameEl.textContent = user.name;
                progressStatEl.textContent = user.progress || '72%';

                nextClassEl.textContent = user.nextClass || 'Physics - 4:00 PM Today';

                if (user.subjects && user.subjects.length) {
                    populateSubjects(user.subjects);
                } else {
                    populateSubjects([]);
                }
            } catch (error) {
                alert(error.message || 'Unable to load dashboard. Redirecting to login.');
                localStorage.removeItem('studentToken');
                sessionStorage.removeItem('studentToken');
                window.location.href = 'login.html';
            }
        };

        const loadInvoice = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/public/enroll/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Unable to load invoice');
                }

                const result = await response.json();
                const enrollments = result.data || [];

                if (!enrollments.length) {
                    invoiceContainer.innerHTML = '<p class="text-gray-500">No invoices found yet.</p>';
                    invoiceDateEl.textContent = '';
                    return;
                }

                const latest = enrollments[0];
                const subjects = latest.subjects || [];

                const formattedDate = latest.createdAt
                    ? new Date(latest.createdAt).toLocaleString()
                    : '';
                invoiceDateEl.textContent = formattedDate ? `Date: ${formattedDate}` : '';

                invoiceContainer.innerHTML = `
                    <div class="border rounded-2xl p-4 bg-gray-50">
                        <div class="flex justify-between items-center mb-3">
                            <div>
                                <p class="text-sm text-gray-500">Student</p>
                                <p class="font-semibold text-gray-800">${latest.studentName || 'N/A'}</p>
                                <p class="text-sm text-gray-500">${latest.email || ''}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-500">Class / Board</p>
                                <p class="font-semibold text-gray-800">Class ${latest.class || '--'} â€¢ ${latest.board || '--'}</p>
                            </div>
                        </div>
                        <table class="w-full text-sm mt-2">
                            <thead>
                                <tr class="text-left text-gray-500 border-b">
                                    <th class="py-2">Subject</th>
                                    <th class="py-2 text-right">Price (â‚¹)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${subjects.map(s => `
                                    <tr class="border-b last:border-0">
                                        <td class="py-2">${s.subject}</td>
                                        <td class="py-2 text-right">${(s.price || 0).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="flex justify-between items-center mt-4 pt-3 border-t">
                            <span class="font-semibold text-gray-700">Total</span>
                            <span class="text-xl font-bold text-purple-700">â‚¹${(latest.totalAmount || 0).toLocaleString()}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Invoice load error:', error);
                invoiceContainer.innerHTML = '<p class="text-red-500">Unable to load invoice at the moment.</p>';
                invoiceDateEl.textContent = '';
            }
        };

        loadDashboard();
        loadInvoice();
    </script>
</body>
</html>
